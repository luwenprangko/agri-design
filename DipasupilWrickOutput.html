<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Food Panda New User Dashboard</title>
		<style>
			:root {
				--primary: #d70f64; /* Food Panda pink */
				--secondary: #1d1d1d;
				--success: #28a745;
				--warning: #ffc107;
				--danger: #dc3545;
				--light: #f8f9fa;
				--dark: #343a40;
				--white: #ffffff;
				--gray: #6c757d;
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				background-color: #f5f5f5;
				color: var(--secondary);
			}

			.dashboard {
				display: flex;
				flex-direction: column;
				height: 100vh;
			}

			header {
				background-color: var(--primary);
				color: var(--white);
				padding: 1rem 2rem;
				display: flex;
				justify-content: space-between;
				align-items: center;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			}

			.logo {
				font-size: 1.5rem;
				font-weight: bold;
				display: flex;
				align-items: center;
			}

			.logo i {
				margin-right: 0.5rem;
				font-size: 1.8rem;
			}

			.main-content {
				display: flex;
				flex: 1;
				overflow: hidden;
			}

			.sidebar {
				width: 250px;
				background-color: var(--white);
				padding: 1rem;
				box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
				overflow-y: auto;
			}

			.sidebar-title {
				font-size: 0.9rem;
				text-transform: uppercase;
				color: var(--gray);
				margin-bottom: 1rem;
				padding-bottom: 0.5rem;
				border-bottom: 1px solid #eee;
			}

			.sidebar-menu {
				list-style: none;
			}

			.sidebar-menu li {
				margin-bottom: 0.5rem;
			}

			.sidebar-menu a {
				display: block;
				padding: 0.75rem 1rem;
				color: var(--secondary);
				text-decoration: none;
				border-radius: 4px;
				transition: all 0.2s;
			}

			.sidebar-menu a:hover,
			.sidebar-menu a.active {
				background-color: rgba(215, 15, 100, 0.1);
				color: var(--primary);
			}

			.sidebar-menu a.active {
				font-weight: bold;
			}

			.sidebar-menu i {
				margin-right: 0.5rem;
				width: 20px;
				text-align: center;
			}

			.content {
				flex: 1;
				padding: 1.5rem;
				overflow-y: auto;
			}

			.page-title {
				margin-bottom: 1.5rem;
				font-size: 1.5rem;
				font-weight: 600;
			}

			.stats-container {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 1rem;
				margin-bottom: 1.5rem;
			}

			.stat-card {
				background-color: var(--white);
				border-radius: 8px;
				padding: 1.25rem;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
			}

			.stat-card-title {
				font-size: 0.9rem;
				color: var(--gray);
				margin-bottom: 0.5rem;
			}

			.stat-card-value {
				font-size: 1.8rem;
				font-weight: bold;
				margin-bottom: 0.5rem;
			}

			.stat-card-info {
				font-size: 0.8rem;
				color: var(--gray);
				display: flex;
				align-items: center;
			}

			.stat-card-info.positive {
				color: var(--success);
			}

			.stat-card-info.negative {
				color: var(--danger);
			}

			.chart-container {
				display: grid;
				grid-template-columns: 2fr 1fr;
				gap: 1rem;
				margin-bottom: 1.5rem;
			}

			.chart-card {
				background-color: var(--white);
				border-radius: 8px;
				padding: 1.25rem;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
			}

			.chart-card-title {
				font-size: 1rem;
				font-weight: 600;
				margin-bottom: 1rem;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.chart-card-title select {
				font-size: 0.8rem;
				padding: 0.25rem 0.5rem;
				border: 1px solid #ddd;
				border-radius: 4px;
				background-color: var(--white);
			}

			.chart {
				height: 300px;
			}

			.table-container {
				background-color: var(--white);
				border-radius: 8px;
				padding: 1.25rem;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
			}

			.table-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1rem;
			}

			.table-title {
				font-size: 1rem;
				font-weight: 600;
			}

			.table-actions {
				display: flex;
				gap: 0.5rem;
			}

			.table-actions button {
				padding: 0.5rem 1rem;
				background-color: var(--white);
				border: 1px solid #ddd;
				border-radius: 4px;
				cursor: pointer;
				font-size: 0.8rem;
				transition: all 0.2s;
			}

			.table-actions button:hover {
				background-color: #f5f5f5;
			}

			.table-actions button.primary {
				background-color: var(--primary);
				color: var(--white);
				border-color: var(--primary);
			}

			.table-actions button.primary:hover {
				background-color: #c00d58;
			}

			table {
				width: 100%;
				border-collapse: collapse;
			}

			th,
			td {
				padding: 0.75rem 1rem;
				text-align: left;
				border-bottom: 1px solid #eee;
			}

			th {
				font-weight: 600;
				color: var(--gray);
				font-size: 0.8rem;
				text-transform: uppercase;
			}

			tbody tr:hover {
				background-color: rgba(0, 0, 0, 0.01);
			}

			.status {
				display: inline-block;
				padding: 0.25rem 0.5rem;
				border-radius: 50px;
				font-size: 0.75rem;
				font-weight: 600;
			}

			.status.delivered {
				background-color: rgba(40, 167, 69, 0.1);
				color: var(--success);
			}

			.status.in-transit {
				background-color: rgba(255, 193, 7, 0.1);
				color: var(--warning);
			}

			.status.delayed {
				background-color: rgba(220, 53, 69, 0.1);
				color: var(--danger);
			}

			.time-remaining {
				display: flex;
				align-items: center;
				font-weight: 600;
			}

			.time-remaining.urgent {
				color: var(--danger);
			}

			.time-remaining.warning {
				color: var(--warning);
			}

			.time-remaining.normal {
				color: var(--success);
			}

			.time-remaining i {
				margin-right: 0.25rem;
			}

			.action-btn {
				background: none;
				border: none;
				cursor: pointer;
				color: var(--primary);
				font-size: 1rem;
			}

			.action-btn:hover {
				color: #c00d58;
			}

			.pagination {
				display: flex;
				justify-content: flex-end;
				margin-top: 1rem;
				gap: 0.25rem;
			}

			.pagination button {
				width: 30px;
				height: 30px;
				display: flex;
				align-items: center;
				justify-content: center;
				border: 1px solid #ddd;
				background-color: var(--white);
				border-radius: 4px;
				cursor: pointer;
				font-size: 0.8rem;
			}

			.pagination button.active {
				background-color: var(--primary);
				color: var(--white);
				border-color: var(--primary);
			}

			.pagination button:hover:not(.active) {
				background-color: #f5f5f5;
			}

			/* Modal styles */
			.modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
				z-index: 1000;
				align-items: center;
				justify-content: center;
			}

			.modal.active {
				display: flex;
			}

			.modal-content {
				background-color: var(--white);
				border-radius: 8px;
				width: 100%;
				max-width: 500px;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
			}

			.modal-header {
				padding: 1rem 1.5rem;
				border-bottom: 1px solid #eee;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.modal-title {
				font-size: 1.2rem;
				font-weight: 600;
			}

			.modal-close {
				background: none;
				border: none;
				font-size: 1.5rem;
				cursor: pointer;
				color: var(--gray);
			}

			.modal-body {
				padding: 1.5rem;
			}

			.modal-footer {
				padding: 1rem 1.5rem;
				border-top: 1px solid #eee;
				display: flex;
				justify-content: flex-end;
				gap: 0.5rem;
			}

			.form-group {
				margin-bottom: 1rem;
			}

			.form-label {
				display: block;
				margin-bottom: 0.5rem;
				font-weight: 600;
				font-size: 0.9rem;
			}

			.form-control {
				width: 100%;
				padding: 0.75rem;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 0.9rem;
			}

			.form-control:focus {
				outline: none;
				border-color: var(--primary);
				box-shadow: 0 0 0 2px rgba(215, 15, 100, 0.1);
			}

			/* Responsive */
			@media (max-width: 992px) {
				.chart-container {
					grid-template-columns: 1fr;
				}
			}

			@media (max-width: 768px) {
				.main-content {
					flex-direction: column;
				}

				.sidebar {
					width: 100%;
					box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
				}

				.stats-container {
					grid-template-columns: 1fr 1fr;
				}
			}

			@media (max-width: 576px) {
				.stats-container {
					grid-template-columns: 1fr;
				}
			}
		</style>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
	</head>
	<body>
		<div class="dashboard">
			<header>
				<div class="logo">
					<i class="fas fa-utensils"></i>
					<span>Food Panda Dashboard</span>
				</div>
				<div>
					<button id="refreshData" class="table-actions button primary">
						<i class="fas fa-sync-alt"></i> Refresh Data
					</button>
				</div>
			</header>

			<div class="main-content">
				<aside class="sidebar">
					<div class="sidebar-title">Main Menu</div>
					<ul class="sidebar-menu">
						<li>
							<a href="#" class="active"
								><i class="fas fa-home"></i> New User Dashboard</a
							>
						</li>
						<li>
							<a href="#"><i class="fas fa-chart-line"></i> Analytics</a>
						</li>
						<li>
							<a href="#"><i class="fas fa-users"></i> All Users</a>
						</li>
						<li>
							<a href="#"><i class="fas fa-store"></i> Restaurants</a>
						</li>
						<li>
							<a href="#"><i class="fas fa-motorcycle"></i> Drivers</a>
						</li>
						<li>
							<a href="#"><i class="fas fa-cog"></i> Settings</a>
						</li>
					</ul>
				</aside>

				<main class="content">
					<h1 class="page-title">New User Dashboard</h1>

					<div class="stats-container">
						<div class="stat-card">
							<div class="stat-card-title">New Users (Last 14 Days)</div>
							<div class="stat-card-value" id="newUserCount">0</div>
							<div class="stat-card-info positive">
								<i class="fas fa-arrow-up"></i> 12% from last week
							</div>
						</div>

						<div class="stat-card">
							<div class="stat-card-title">Avg. Delivery Time</div>
							<div class="stat-card-value" id="avgDeliveryTime">0 min</div>
							<div class="stat-card-info negative">
								<i class="fas fa-arrow-up"></i> 5% from target
							</div>
						</div>

						<div class="stat-card">
							<div class="stat-card-title">Incorrect Order Rate</div>
							<div class="stat-card-value" id="incorrectOrderRate">0%</div>
							<div class="stat-card-info positive">
								<i class="fas fa-arrow-down"></i> 3% from last week
							</div>
						</div>

						<div class="stat-card">
							<div class="stat-card-title">Address Issue Rate</div>
							<div class="stat-card-value" id="addressIssueRate">0%</div>
							<div class="stat-card-info negative">
								<i class="fas fa-arrow-up"></i> 2% from last week
							</div>
						</div>
					</div>

					<div class="chart-container">
						<div class="chart-card">
							<div class="chart-card-title">
								<span>New User Order Performance</span>
								<select id="chartTimeRange">
									<option value="7">Last 7 Days</option>
									<option value="14" selected>Last 14 Days</option>
									<option value="30">Last 30 Days</option>
								</select>
							</div>
							<div class="chart" id="performanceChart"></div>
						</div>

						<div class="chart-card">
							<div class="chart-card-title">
								<span>Issue Distribution</span>
							</div>
							<div class="chart" id="issueDistributionChart"></div>
						</div>
					</div>

					<div class="table-container">
						<div class="table-header">
							<div class="table-title">New Users with Active Orders</div>
							<div class="table-actions">
								<button id="priorityFilter" class="primary">
									<i class="fas fa-filter"></i> Show Priority Users
								</button>
								<button id="addDummyData">
									<i class="fas fa-plus"></i> Add Dummy Data
								</button>
							</div>
						</div>

						<table>
							<thead>
								<tr>
									<th>User ID</th>
									<th>Registration Date</th>
									<th>Time Left</th>
									<th>Orders</th>
									<th>Latest Order</th>
									<th>Status</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody id="newUserTable">
								<!-- Table data will be populated by JavaScript -->
							</tbody>
						</table>

						<div class="pagination" id="pagination">
							<!-- Pagination will be populated by JavaScript -->
						</div>
					</div>
				</main>
			</div>
		</div>

		<!-- Order Details Modal -->
		<div class="modal" id="orderDetailsModal">
			<div class="modal-content">
				<div class="modal-header">
					<h2 class="modal-title">Order Details</h2>
					<button class="modal-close" id="closeOrderModal">&times;</button>
				</div>
				<div class="modal-body" id="orderDetailsContent">
					<!-- Order details will be populated by JavaScript -->
				</div>
				<div class="modal-footer">
					<button class="table-actions button" id="closeOrderModalBtn">
						Close
					</button>
					<button class="table-actions button primary" id="prioritizeOrderBtn">
						Prioritize Order
					</button>
				</div>
			</div>
		</div>

		<!-- User Details Modal -->
		<div class="modal" id="userDetailsModal">
			<div class="modal-content">
				<div class="modal-header">
					<h2 class="modal-title">User Details</h2>
					<button class="modal-close" id="closeUserModal">&times;</button>
				</div>
				<div class="modal-body" id="userDetailsContent">
					<!-- User details will be populated by JavaScript -->
				</div>
				<div class="modal-footer">
					<button class="table-actions button" id="closeUserModalBtn">
						Close
					</button>
					<button class="table-actions button primary" id="prioritizeUserBtn">
						Prioritize User
					</button>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script>
			// IndexedDB setup
			let db;
			const DB_NAME = "foodPandaDB";
			const DB_VERSION = 1;
			const STORES = {
				USERS: "users",
				ORDERS: "orders",
				ISSUES: "issues",
			};

			// Initialize IndexedDB
			function initDB() {
				return new Promise((resolve, reject) => {
					const request = indexedDB.open(DB_NAME, DB_VERSION);

					request.onerror = (event) => {
						console.error("IndexedDB error:", event.target.error);
						reject("Could not open IndexedDB");
					};

					request.onsuccess = (event) => {
						db = event.target.result;
						console.log("IndexedDB opened successfully");
						resolve(db);
					};

					request.onupgradeneeded = (event) => {
						const db = event.target.result;

						// Create Users store
						if (!db.objectStoreNames.contains(STORES.USERS)) {
							const usersStore = db.createObjectStore(STORES.USERS, {
								keyPath: "userId",
							});
							usersStore.createIndex("registrationDate", "registrationDate", {
								unique: false,
							});
							usersStore.createIndex("isNewUser", "isNewUser", {
								unique: false,
							});
						}

						// Create Orders store
						if (!db.objectStoreNames.contains(STORES.ORDERS)) {
							const ordersStore = db.createObjectStore(STORES.ORDERS, {
								keyPath: "orderId",
							});
							ordersStore.createIndex("userId", "userId", { unique: false });
							ordersStore.createIndex("orderDate", "orderDate", {
								unique: false,
							});
							ordersStore.createIndex("status", "status", { unique: false });
						}

						// Create Issues store
						if (!db.objectStoreNames.contains(STORES.ISSUES)) {
							const issuesStore = db.createObjectStore(STORES.ISSUES, {
								keyPath: "issueId",
							});
							issuesStore.createIndex("orderId", "orderId", { unique: false });
							issuesStore.createIndex("issueType", "issueType", {
								unique: false,
							});
						}
					};
				});
			}

			// Add data to IndexedDB
			function addData(storeName, data) {
				return new Promise((resolve, reject) => {
					const transaction = db.transaction(storeName, "readwrite");
					const store = transaction.objectStore(storeName);
					const request = store.add(data);

					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(request.error);
				});
			}

			// Get all data from a store
			function getAllData(storeName) {
				return new Promise((resolve, reject) => {
					const transaction = db.transaction(storeName, "readonly");
					const store = transaction.objectStore(storeName);
					const request = store.getAll();

					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(request.error);
				});
			}

			// Get data by index
			function getDataByIndex(storeName, indexName, value) {
				return new Promise((resolve, reject) => {
					const transaction = db.transaction(storeName, "readonly");
					const store = transaction.objectStore(storeName);
					const index = store.index(indexName);
					const request = index.getAll(value);

					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(request.error);
				});
			}

			// Clear all data from a store
			function clearStore(storeName) {
				return new Promise((resolve, reject) => {
					const transaction = db.transaction(storeName, "readwrite");
					const store = transaction.objectStore(storeName);
					const request = store.clear();

					request.onsuccess = () => resolve();
					request.onerror = () => reject(request.error);
				});
			}

			// Generate random date within the last 14 days
			function getRandomRecentDate(maxDaysAgo = 14) {
				const now = new Date();
				const daysAgo = Math.floor(Math.random() * maxDaysAgo);
				const hoursAgo = Math.floor(Math.random() * 24);
				const minutesAgo = Math.floor(Math.random() * 60);

				now.setDate(now.getDate() - daysAgo);
				now.setHours(now.getHours() - hoursAgo);
				now.setMinutes(now.getMinutes() - minutesAgo);

				return now;
			}

			// Generate random user data
			function generateRandomUsers(count = 20) {
				const users = [];

				for (let i = 1; i <= count; i++) {
					const registrationDate = getRandomRecentDate();
					const user = {
						userId: `U${String(i).padStart(4, "0")}`,
						name: `User ${i}`,
						email: `user${i}@example.com`,
						phone: `+1${Math.floor(Math.random() * 9000000000) + 1000000000}`,
						registrationDate: registrationDate,
						isNewUser: true, // All users are new (within 14 days)
						address: `${Math.floor(Math.random() * 999) + 1} ${
							["Main", "Oak", "Maple", "Pine", "Cedar"][
								Math.floor(Math.random() * 5)
							]
						} St, City ${Math.floor(Math.random() * 99) + 1}`,
						orderCount: Math.floor(Math.random() * 5) + 1,
					};

					users.push(user);
				}

				return users;
			}

			// Generate random order data for users
			function generateRandomOrders(users) {
				const orders = [];
				let orderIdCounter = 1;

				const orderStatuses = ["delivered", "in-transit", "delayed"];

				users.forEach((user) => {
					const orderCount =
						user.orderCount || Math.floor(Math.random() * 3) + 1;

					for (let i = 0; i < orderCount; i++) {
						const orderDate = new Date(user.registrationDate);
						// Add random hours to the registration date
						orderDate.setHours(
							orderDate.getHours() + Math.floor(Math.random() * 24 * 14)
						);

						const estimatedDeliveryTime = 30; // 30 minutes
						const actualDeliveryTime = Math.floor(
							estimatedDeliveryTime *
								(Math.random() < 0.3 ? 1 + Math.random() * 0.5 : 1)
						);

						const status =
							orderStatuses[Math.floor(Math.random() * orderStatuses.length)];

						const order = {
							orderId: `O${String(orderIdCounter++).padStart(4, "0")}`,
							userId: user.userId,
							restaurantId: `R${String(
								Math.floor(Math.random() * 20) + 1
							).padStart(3, "0")}`,
							orderDate: orderDate,
							status: status,
							items: Math.floor(Math.random() * 5) + 1,
							totalAmount: Math.floor(Math.random() * 5000) / 100 + 10,
							estimatedDeliveryTime: estimatedDeliveryTime,
							actualDeliveryTime: actualDeliveryTime,
							isCorrect: Math.random() > 0.2,
							isDelivered: status === "delivered",
						};

						orders.push(order);
					}
				});

				return orders;
			}

			// Generate random issues for orders
			function generateRandomIssues(orders) {
				const issues = [];
				let issueIdCounter = 1;

				const issueTypes = [
					"incorrect_order",
					"address_issue",
					"late_delivery",
				];

				orders.forEach((order) => {
					// Only create issues for some orders
					if (Math.random() < 0.3) {
						const issueType =
							issueTypes[Math.floor(Math.random() * issueTypes.length)];

						const issue = {
							issueId: `I${String(issueIdCounter++).padStart(4, "0")}`,
							orderId: order.orderId,
							issueType: issueType,
							reportedDate: new Date(
								order.orderDate.getTime() +
									Math.floor(Math.random() * 60 * 60 * 1000)
							),
							resolved: Math.random() > 0.5,
							priority: Math.floor(Math.random() * 3) + 1, // 1-3, with 3 being highest
						};

						issues.push(issue);
					}
				});

				return issues;
			}

			// Calculate time remaining for new users (14-day window)
			function calculateTimeRemaining(registrationDate) {
				const now = new Date();
				const endDate = new Date(registrationDate);
				endDate.setDate(endDate.getDate() + 14);

				const timeRemaining = endDate - now;

				if (timeRemaining <= 0) {
					return { days: 0, hours: 0, minutes: 0, expired: true };
				}

				const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
				const hours = Math.floor(
					(timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
				);
				const minutes = Math.floor(
					(timeRemaining % (1000 * 60 * 60)) / (1000 * 60)
				);

				return { days, hours, minutes, expired: false };
			}

			// Format time remaining for display
			function formatTimeRemaining(timeObj) {
				if (timeObj.expired) {
					return '<span class="time-remaining">Expired</span>';
				}

				let className = "time-remaining";
				let icon = "";

				if (timeObj.days === 0 && timeObj.hours < 12) {
					className += " urgent";
					icon = '<i class="fas fa-exclamation-circle"></i>';
				} else if (timeObj.days < 2) {
					className += " warning";
					icon = '<i class="fas fa-exclamation-triangle"></i>';
				} else {
					className += " normal";
					icon = '<i class="fas fa-clock"></i>';
				}

				return `<span class="${className}">${icon} ${timeObj.days}d ${timeObj.hours}h ${timeObj.minutes}m</span>`;
			}

			// Format date for display
			function formatDate(date) {
				return new Date(date).toLocaleString("en-US", {
					year: "numeric",
					month: "short",
					day: "numeric",
					hour: "2-digit",
					minute: "2-digit",
				});
			}

			// Render user table
			function renderUserTable(
				users,
				orders,
				currentPage = 1,
				showPriority = false
			) {
				const tableBody = document.getElementById("newUserTable");
				tableBody.innerHTML = "";

				const itemsPerPage = 10;
				const startIndex = (currentPage - 1) * itemsPerPage;

				// Filter users if showing priority only
				let filteredUsers = [...users];
				if (showPriority) {
					filteredUsers = users.filter((user) => {
						const timeRemaining = calculateTimeRemaining(user.registrationDate);
						return (
							timeRemaining.days < 2 ||
							(timeRemaining.days === 2 && timeRemaining.hours < 12)
						);
					});
				}

				// Sort users by time remaining (ascending)
				filteredUsers.sort((a, b) => {
					const timeA = calculateTimeRemaining(a.registrationDate);
					const timeB = calculateTimeRemaining(b.registrationDate);

					if (timeA.expired !== timeB.expired) {
						return timeA.expired ? 1 : -1;
					}

					if (timeA.days !== timeB.days) return timeA.days - timeB.days;
					if (timeA.hours !== timeB.hours) return timeA.hours - timeB.hours;
					return timeA.minutes - timeB.minutes;
				});

				const paginatedUsers = filteredUsers.slice(
					startIndex,
					startIndex + itemsPerPage
				);

				// Create user rows
				paginatedUsers.forEach((user) => {
					const userOrders = orders.filter(
						(order) => order.userId === user.userId
					);
					const latestOrder =
						userOrders.length > 0
							? userOrders.sort(
									(a, b) => new Date(b.orderDate) - new Date(a.orderDate)
							  )[0]
							: null;

					const timeRemaining = calculateTimeRemaining(user.registrationDate);
					const formattedTimeRemaining = formatTimeRemaining(timeRemaining);

					const row = document.createElement("tr");
					row.innerHTML = `
          <td>${user.userId}</td>
          <td>${formatDate(user.registrationDate)}</td>
          <td>${formattedTimeRemaining}</td>
          <td>${userOrders.length}</td>
          <td>${latestOrder ? formatDate(latestOrder.orderDate) : "N/A"}</td>
          <td>${
						latestOrder
							? `<span class="status ${latestOrder.status}">${latestOrder.status}</span>`
							: "N/A"
					}</td>
          <td>
            <button class="action-btn view-user" data-userid="${user.userId}">
              <i class="fas fa-eye"></i>
            </button>
            ${
							latestOrder
								? `<button class="action-btn view-order" data-orderid="${latestOrder.orderId}">
                <i class="fas fa-receipt"></i>
              </button>`
								: ""
						}
          </td>
        `;

					tableBody.appendChild(row);
				});

				// Render pagination
				renderPagination(filteredUsers.length, itemsPerPage, currentPage);

				// Add event listeners to buttons
				document.querySelectorAll(".view-user").forEach((btn) => {
					btn.addEventListener("click", () =>
						showUserDetails(btn.dataset.userid)
					);
				});

				document.querySelectorAll(".view-order").forEach((btn) => {
					btn.addEventListener("click", () =>
						showOrderDetails(btn.dataset.orderid)
					);
				});
			}

			// Render pagination
			function renderPagination(totalItems, itemsPerPage, currentPage) {
				const paginationContainer = document.getElementById("pagination");
				paginationContainer.innerHTML = "";

				const totalPages = Math.ceil(totalItems / itemsPerPage);

				if (totalPages <= 1) return;

				// Previous button
				if (currentPage > 1) {
					const prevBtn = document.createElement("button");
					prevBtn.innerHTML = "&laquo;";
					prevBtn.addEventListener("click", () =>
						renderUserTable(
							allUsers,
							allOrders,
							currentPage - 1,
							showPriorityOnly
						)
					);
					paginationContainer.appendChild(prevBtn);
				}

				// Page buttons
				for (let i = 1; i <= totalPages; i++) {
					const pageBtn = document.createElement("button");
					pageBtn.textContent = i;
					if (i === currentPage) {
						pageBtn.classList.add("active");
					}
					pageBtn.addEventListener("click", () =>
						renderUserTable(allUsers, allOrders, i, showPriorityOnly)
					);
					paginationContainer.appendChild(pageBtn);
				}

				// Next button
				if (currentPage < totalPages) {
					const nextBtn = document.createElement("button");
					nextBtn.innerHTML = "&raquo;";
					nextBtn.addEventListener("click", () =>
						renderUserTable(
							allUsers,
							allOrders,
							currentPage + 1,
							showPriorityOnly
						)
					);
					paginationContainer.appendChild(nextBtn);
				}
			}

			// Show user details in modal
			function showUserDetails(userId) {
				getAllData(STORES.USERS).then((users) => {
					const user = users.find((u) => u.userId === userId);

					if (!user) return;

					getAllData(STORES.ORDERS).then((orders) => {
						const userOrders = orders.filter(
							(order) => order.userId === userId
						);

						const timeRemaining = calculateTimeRemaining(user.registrationDate);
						const formattedTimeRemaining = timeRemaining.expired
							? "Expired"
							: `${timeRemaining.days} days, ${timeRemaining.hours} hours, ${timeRemaining.minutes} minutes`;

						const userDetailsContent =
							document.getElementById("userDetailsContent");
						userDetailsContent.innerHTML = `
            <div class="form-group">
              <div class="form-label">User ID:</div>
              <div>${user.userId}</div>
            </div>
            <div class="form-group">
              <div class="form-label">Name:</div>
              <div>${user.name}</div>
            </div>
            <div class="form-group">
              <div class="form-label">Email:</div>
              <div>${user.email}</div>
            </div>
            <div class="form-group">
              <div class="form-label">Phone:</div>
              <div>${user.phone}</div>
            </div>
            <div class="form-group">
              <div class="form-label">Address:</div>
              <div>${user.address}</div>
            </div>
            <div class="form-group">
              <div class="form-label">Registration Date:</div>
              <div>${formatDate(user.registrationDate)}</div>
            </div>
            <div class="form-group">
              <div class="form-label">Time Remaining:</div>
              <div>${formattedTimeRemaining}</div>
            </div>
            <div class="form-group">
              <div class="form-label">Total Orders:</div>
              <div>${userOrders.length}</div>
            </div>
            
            ${
							userOrders.length > 0
								? `
              <h3 style="margin-top: 20px; margin-bottom: 10px;">Order History</h3>
              <table style="width: 100%;">
                <thead>
                  <tr>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Amount</th>
                  </tr>
                </thead>
                <tbody>
                  ${userOrders
										.map(
											(order) => `
                    <tr>
                      <td>${order.orderId}</td>
                      <td>${formatDate(order.orderDate)}</td>
                      <td><span class="status ${order.status}">${
												order.status
											}</span></td>
                      <td>$${order.totalAmount.toFixed(2)}</td>
                    </tr>
                  `
										)
										.join("")}
                </tbody>
              </table>
            `
								: ""
						}
          `;

						document.getElementById("userDetailsModal").classList.add("active");
					});
				});
			}

			// Show order details in modal
			function showOrderDetails(orderId) {
				getAllData(STORES.ORDERS).then((orders) => {
					const order = orders.find((o) => o.orderId === orderId);

					if (!order) return;

					getAllData(STORES.USERS).then((users) => {
						const user = users.find((u) => u.userId === order.userId);

						getAllData(STORES.ISSUES).then((issues) => {
							const orderIssues = issues.filter(
								(issue) => issue.orderId === orderId
							);

							const orderDetailsContent = document.getElementById(
								"orderDetailsContent"
							);
							orderDetailsContent.innerHTML = `
              <div class="form-group">
                <div class="form-label">Order ID:</div>
                <div>${order.orderId}</div>
              </div>
              <div class="form-group">
                <div class="form-label">User:</div>
                <div>${user ? user.name : "Unknown"} (${order.userId})</div>
              </div>
              <div class="form-group">
                <div class="form-label">Restaurant:</div>
                <div>${order.restaurantId}</div>
              </div>
              <div class="form-group">
                <div class="form-label">Order Date:</div>
                <div>${formatDate(order.orderDate)}</div>
              </div>
              <div class="form-group">
                <div class="form-label">Status:</div>
                <div><span class="status ${order.status}">${
								order.status
							}</span></div>
              </div>
              <div class="form-group">
                <div class="form-label">Items:</div>
                <div>${order.items}</div>
              </div>
              <div class="form-group">
                <div class="form-label">Total Amount:</div>
                <div>$${order.totalAmount.toFixed(2)}</div>
              </div>
              <div class="form-group">
                <div class="form-label">Estimated Delivery Time:</div>
                <div>${order.estimatedDeliveryTime} minutes</div>
              </div>
              <div class="form-group">
                <div class="form-label">Actual Delivery Time:</div>
                <div>${order.actualDeliveryTime} minutes</div>
              </div>
              <div class="form-group">
                <div class="form-label">Correct Order:</div>
                <div>${order.isCorrect ? "Yes" : "No"}</div>
              </div>
              <div class="form-group">
                <div class="form-label">Delivered:</div>
                <div>${order.isDelivered ? "Yes" : "No"}</div>
              </div>
              
              ${
								orderIssues.length > 0
									? `
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Issues</h3>
                <table style="width: 100%;">
                  <thead>
                    <tr>
                      <th>Issue ID</th>
                      <th>Type</th>
                      <th>Reported</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${orderIssues
											.map(
												(issue) => `
                      <tr>
                        <td>${issue.issueId}</td>
                        <td>${issue.issueType.replace("_", " ")}</td>
                        <td>${formatDate(issue.reportedDate)}</td>
                        <td>${issue.resolved ? "Resolved" : "Pending"}</td>
                      </tr>
                    `
											)
											.join("")}
                  </tbody>
                </table>
              `
									: ""
							}
            `;

							document
								.getElementById("orderDetailsModal")
								.classList.add("active");
						});
					});
				});
			}

			// Update dashboard statistics
			function updateDashboardStats() {
				Promise.all([
					getAllData(STORES.USERS),
					getAllData(STORES.ORDERS),
					getAllData(STORES.ISSUES),
				]).then(([users, orders, issues]) => {
					// Update user count
					document.getElementById("newUserCount").textContent = users.length;

					// Calculate average delivery time
					const deliveryTimes = orders
						.map((order) => order.actualDeliveryTime)
						.filter((time) => time);
					const avgDeliveryTime =
						deliveryTimes.length > 0
							? deliveryTimes.reduce((sum, time) => sum + time, 0) /
							  deliveryTimes.length
							: 0;
					document.getElementById(
						"avgDeliveryTime"
					).textContent = `${Math.round(avgDeliveryTime)} min`;

					// Calculate incorrect order rate
					const incorrectOrders = orders.filter(
						(order) => !order.isCorrect
					).length;
					const incorrectRate =
						orders.length > 0 ? (incorrectOrders / orders.length) * 100 : 0;
					document.getElementById(
						"incorrectOrderRate"
					).textContent = `${incorrectRate.toFixed(1)}%`;

					// Calculate address issue rate
					const addressIssues = issues.filter(
						(issue) => issue.issueType === "address_issue"
					).length;
					const addressIssueRate =
						orders.length > 0 ? (addressIssues / orders.length) * 100 : 0;
					document.getElementById(
						"addressIssueRate"
					).textContent = `${addressIssueRate.toFixed(1)}%`;

					// Create performance chart
					createPerformanceChart(orders);

					// Create issue distribution chart
					createIssueDistributionChart(issues);
				});
			}

			// Create performance chart
			function createPerformanceChart(orders) {
				const ctx = document
					.getElementById("performanceChart")
					.getContext("2d");

				// Get selected time range
				const timeRange = parseInt(
					document.getElementById("chartTimeRange").value
				);

				// Group orders by date
				const now = new Date();
				const dates = [];
				const correctData = [];
				const incorrectData = [];
				const lateData = [];

				for (let i = timeRange - 1; i >= 0; i--) {
					const date = new Date(now);
					date.setDate(date.getDate() - i);
					date.setHours(0, 0, 0, 0);
					dates.push(
						date.toLocaleDateString("en-US", { month: "short", day: "numeric" })
					);

					const dayOrders = orders.filter((order) => {
						const orderDate = new Date(order.orderDate);
						return (
							orderDate.getDate() === date.getDate() &&
							orderDate.getMonth() === date.getMonth() &&
							orderDate.getFullYear() === date.getFullYear()
						);
					});

					const correct = dayOrders.filter(
						(order) => order.isCorrect && order.actualDeliveryTime <= 30
					).length;
					const incorrect = dayOrders.filter(
						(order) => !order.isCorrect
					).length;
					const late = dayOrders.filter(
						(order) => order.actualDeliveryTime > 30
					).length;

					correctData.push(correct);
					incorrectData.push(incorrect);
					lateData.push(late);
				}

				// Destroy existing chart if it exists
				if (window.performanceChart) {
					window.performanceChart.destroy();
				}

				// Create new chart
				window.performanceChart = new Chart(ctx, {
					type: "bar",
					data: {
						labels: dates,
						datasets: [
							{
								label: "Correct & On-Time",
								data: correctData,
								backgroundColor: "#28a745",
							},
							{
								label: "Incorrect Orders",
								data: incorrectData,
								backgroundColor: "#dc3545",
							},
							{
								label: "Late Deliveries",
								data: lateData,
								backgroundColor: "#ffc107",
							},
						],
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							x: {
								stacked: true,
							},
							y: {
								stacked: true,
								beginAtZero: true,
							},
						},
					},
				});
			}

			// Create issue distribution chart
			function createIssueDistributionChart(issues) {
				const ctx = document
					.getElementById("issueDistributionChart")
					.getContext("2d");

				// Count issues by type
				const incorrectOrders = issues.filter(
					(issue) => issue.issueType === "incorrect_order"
				).length;
				const addressIssues = issues.filter(
					(issue) => issue.issueType === "address_issue"
				).length;
				const lateDeliveries = issues.filter(
					(issue) => issue.issueType === "late_delivery"
				).length;

				// Destroy existing chart if it exists
				if (window.issueDistributionChart) {
					window.issueDistributionChart.destroy();
				}

				// Create new chart
				window.issueDistributionChart = new Chart(ctx, {
					type: "doughnut",
					data: {
						labels: ["Incorrect Orders", "Address Issues", "Late Deliveries"],
						datasets: [
							{
								data: [incorrectOrders, addressIssues, lateDeliveries],
								backgroundColor: ["#dc3545", "#fd7e14", "#ffc107"],
							},
						],
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: {
								position: "bottom",
							},
						},
					},
				});
			}

			// Global variables
			let allUsers = [];
			let allOrders = [];
			let allIssues = [];
			let showPriorityOnly = false;
			let currentPage = 1;

			// Add dummy data to IndexedDB
			function addDummyData() {
				// Clear existing data
				Promise.all([
					clearStore(STORES.USERS),
					clearStore(STORES.ORDERS),
					clearStore(STORES.ISSUES),
				]).then(() => {
					// Generate random data
					const users = generateRandomUsers(20);
					const orders = generateRandomOrders(users);
					const issues = generateRandomIssues(orders);

					// Add data to IndexedDB
					const promises = [];

					users.forEach((user) => {
						promises.push(addData(STORES.USERS, user));
					});

					orders.forEach((order) => {
						promises.push(addData(STORES.ORDERS, order));
					});

					issues.forEach((issue) => {
						promises.push(addData(STORES.ISSUES, issue));
					});

					Promise.all(promises).then(() => {
						// Update global variables
						allUsers = users;
						allOrders = orders;
						allIssues = issues;

						// Update dashboard
						updateDashboardStats();
						renderUserTable(users, orders, 1, showPriorityOnly);

						console.log("Dummy data added successfully");
					});
				});
			}

			// Initialize the dashboard
			function initDashboard() {
				// Initialize IndexedDB
				initDB()
					.then(() => {
						// Load data from IndexedDB
						Promise.all([
							getAllData(STORES.USERS),
							getAllData(STORES.ORDERS),
							getAllData(STORES.ISSUES),
						]).then(([users, orders, issues]) => {
							// Update global variables
							allUsers = users;
							allOrders = orders;
							allIssues = issues;

							// If no data exists, add dummy data
							if (users.length === 0) {
								addDummyData();
							} else {
								// Update dashboard
								updateDashboardStats();
								renderUserTable(users, orders, 1, showPriorityOnly);
							}
						});
					})
					.catch((error) => {
						console.error("Failed to initialize dashboard:", error);
					});
			}

			// Event listeners
			document.addEventListener("DOMContentLoaded", () => {
				// Initialize dashboard
				initDashboard();

				// Add dummy data button
				document
					.getElementById("addDummyData")
					.addEventListener("click", addDummyData);

				// Refresh data button
				document.getElementById("refreshData").addEventListener("click", () => {
					updateDashboardStats();
					renderUserTable(allUsers, allOrders, currentPage, showPriorityOnly);
				});

				// Priority filter button
				document
					.getElementById("priorityFilter")
					.addEventListener("click", () => {
						showPriorityOnly = !showPriorityOnly;
						document.getElementById("priorityFilter").textContent =
							showPriorityOnly ? "Show All Users" : "Show Priority Users";
						renderUserTable(allUsers, allOrders, 1, showPriorityOnly);
					});

				// Chart time range selector
				document
					.getElementById("chartTimeRange")
					.addEventListener("change", () => {
						createPerformanceChart(allOrders);
					});

				// Modal close buttons
				document
					.getElementById("closeOrderModal")
					.addEventListener("click", () => {
						document
							.getElementById("orderDetailsModal")
							.classList.remove("active");
					});

				document
					.getElementById("closeOrderModalBtn")
					.addEventListener("click", () => {
						document
							.getElementById("orderDetailsModal")
							.classList.remove("active");
					});

				document
					.getElementById("closeUserModal")
					.addEventListener("click", () => {
						document
							.getElementById("userDetailsModal")
							.classList.remove("active");
					});

				document
					.getElementById("closeUserModalBtn")
					.addEventListener("click", () => {
						document
							.getElementById("userDetailsModal")
							.classList.remove("active");
					});

				// Prioritize buttons
				document
					.getElementById("prioritizeOrderBtn")
					.addEventListener("click", () => {
						alert("Order has been prioritized!");
						document
							.getElementById("orderDetailsModal")
							.classList.remove("active");
					});

				document
					.getElementById("prioritizeUserBtn")
					.addEventListener("click", () => {
						alert("User has been prioritized!");
						document
							.getElementById("userDetailsModal")
							.classList.remove("active");
					});
			});
		</script>
	</body>
</html>
